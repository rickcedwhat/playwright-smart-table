import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// Recreate __dirname for ESM
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const srcPath = path.join(__dirname, '../src/types.ts');
const destPath = path.join(__dirname, '../src/minimalConfigContext.ts');

try {
    // Manually craft minimal config context - only what LLMs need for selectors
    let minimalContent = `/**
 * Flexible selector type - can be a CSS string or function returning a Locator.
 * @example
 * // String selector
 * rowSelector: 'tbody tr'
 * 
 * // Function selector
 * rowSelector: (root) => root.locator('[role="row"]')
 */
export type Selector = string | ((root: Locator | Page) => Locator);

/**
 * Debug configuration for development and troubleshooting
 */
export type DebugConfig = {
  slow?: number | {
    pagination?: number;
    getCell?: number;
    findRow?: number;
    default?: number;
  };
  logLevel?: 'verbose' | 'info' | 'error' | 'none';
};

/**
 * Configuration options for useTable - focus on selectors and basic setup
 */
export interface TableConfig<T = any> {
  /** CSS selector or function for table headers */
  headerSelector?: string | ((root: Locator) => Locator);
  
  /** CSS selector or function for table rows */
  rowSelector?: string | ((root: Locator) => Locator);
  
  /** CSS selector or function for cells within a row */
  cellSelector?: string | ((row: Locator) => Locator);
  
  /** Transform header text (e.g., normalize, deduplicate) */
  headerTransformer?: (args: { 
    text: string; 
    index: number; 
    locator: Locator;
    seenHeaders: Set<string>;
  }) => string | Promise<string>;
  
  /** Automatically scroll to table on init (default: true) */
  autoScroll?: boolean;
  
  /** Debug options for development and troubleshooting */
  debug?: DebugConfig;
  
  /** Advanced: Custom strategies for pagination, sorting, navigation, etc. */
  strategies?: TableStrategies;
}

/**
 * Example usage:
 */
// const table = useTable(page.locator('table'), {
//   headerSelector: 'thead th',
//   rowSelector: 'tbody tr',
//   cellSelector: 'td',
//   headerTransformer: ({ text }) => text.trim()
// });
`;

    // Escape special characters for template literal
    minimalContent = minimalContent
        .replace(/\\/g, '\\\\')  // Escape backslashes first
        .replace(/`/g, '\\`')        // Escape backticks
        .replace(/\$\{/g, '\\${');  // Escape interpolation start

    // Create the output file content
    const fileContent = `/**
 * ü§ñ AUTO-GENERATED FILE. DO NOT EDIT.
 * This file is generated by scripts/embed-config-types.mjs
 * It contains minimal type definitions for config generation prompts.
 */
export const MINIMAL_CONFIG_CONTEXT = \`
${minimalContent}
\`;
`;

    // Write to src/minimalConfigContext.ts
    fs.writeFileSync(destPath, fileContent);
    console.log('‚úÖ Config types successfully embedded into src/minimalConfigContext.ts');

} catch (e) {
    console.error('‚ùå Failed to embed config types:', e);
    process.exit(1);
}
